<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enthusia 5.0 Visualizer</title>
    <style>
        /* --- COPY THIS CSS TO YOUR STYLESHEET --- */

        body {
            margin: 0;
            background-color: #0d0d0d; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
        }

        /* Container for the whole strip */
        .visualizer-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 150px; 
            background-color: transparent; 
            position: relative;
            overflow: hidden;
            padding: 0 40px;
            box-sizing: border-box;
            cursor: pointer; /* Shows hand icon to indicate clickable */
        }

        /* The canvas lines */
        .vis-canvas {
            flex: 1; 
            height: 100%;
            display: block;
            min-width: 50px;
        }
        
        /* The blank space in the middle */
        .visualizer-spacer {
            width: 300px; 
            height: 1px;  
            flex-shrink: 0; 
        }

        /* The Audio Player is now completely hidden */
        .visualizer-audio {
            display: none;
        }

        /* Start Prompt */
        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }
        
        .start-text {
            color: rgba(255,255,255,0.3);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            pointer-events: none;
        }

        .hidden {
            display: none !important;
        }

        .error-msg {
            color: #ff4444;
            font-size: 12px;
            position: absolute;
            bottom: 5px;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- VISUALIZER WIDGET START -->
    <!-- Added onclick handler directly to container -->
    <div class="visualizer-container" id="vis-container">
        
        <!-- Left Line -->
        <canvas id="vis-left" class="vis-canvas"></canvas>
        
        <!-- Empty Middle Space -->
        <div class="visualizer-spacer">
            <div id="start-msg" class="start-overlay">
                <span class="start-text">Click to Start</span>
            </div>
        </div>
        
        <!-- Right Line -->
        <canvas id="vis-right" class="vis-canvas"></canvas>

        <!-- Error Message Display -->
        <div id="error-log" class="error-msg"></div>

        <!-- Audio Player (Hidden, no controls) -->
        <audio id="audio" class="visualizer-audio" loop crossorigin="anonymous">
            <source src="The%20Neighbourhood%20-%20Softcore%20-%20%5BIntro%20Looped%20%26%20Slowed%20Reverb%5D%20(128kbit_AAC).mp3" type="audio/mpeg">
        </audio>
    </div>
    <!-- VISUALIZER WIDGET END -->

    <script>
        // Configuration
        const LINE_COLOR = '#ffffff'; 
        const LINE_WIDTH = 1;         
        
        // Elements
        const container = document.getElementById('vis-container');
        const audio = document.getElementById('audio');
        const startMsg = document.getElementById('start-msg');
        const errorLog = document.getElementById('error-log');
        const canvases = [
            document.getElementById('vis-left'), 
            document.getElementById('vis-right')
        ];
        
        let audioContext;
        let analyser;
        let source;
        let animationId;
        let isInitialized = false;

        // Browsers REQUIRE a user interaction (click) to start AudioContext
        container.addEventListener('click', () => {
            if (!isInitialized) {
                initAudio();
                // Ensure context is running (sometimes it starts suspended)
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                audio.play()
                    .then(() => {
                        startMsg.classList.add('hidden');
                        isInitialized = true;
                        errorLog.innerText = ""; // Clear errors on success
                    })
                    .catch(err => {
                        console.error("Playback failed:", err);
                        // Specific error for the "File not on server" issue
                        if (err.name === 'NotSupportedError' || err.message.includes('crossorigin')) {
                             errorLog.innerText = "Error: Run this on a Local Server (VS Code Live Server), not file://";
                        } else {
                             errorLog.innerText = "Playback Error: Click again.";
                        }
                    });
            } else {
                // Toggle Play/Pause on subsequent clicks
                if (audio.paused) audio.play(); 
                else audio.pause();
            }
        });

        function initAudio() {
            if (audioContext) return;

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; 
                
                // Create the source connection
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                renderFrame();
            } catch (e) {
                console.error("Audio Context Error:", e);
                if (window.location.protocol === 'file:') {
                    errorLog.innerText = "Security Alert: Visualizers cannot run on local files. Upload to a website or use Live Server.";
                }
            }
        }

        function renderFrame() {
            animationId = requestAnimationFrame(renderFrame);

            if (!analyser) return;

            const bufferLength = analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            canvases.forEach((canvas) => {
                const ctx = canvas.getContext('2d');

                if (canvas.width !== canvas.offsetWidth || canvas.height !== canvas.offsetHeight) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.lineWidth = LINE_WIDTH;
                ctx.strokeStyle = LINE_COLOR;
                ctx.shadowBlur = 8;
                ctx.shadowColor = LINE_COLOR;
                
                ctx.beginPath();
                
                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0; 
                    const y = (v * canvas.height) / 2;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);

                    x += sliceWidth;
                }

                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
            });
        }
        
        audio.addEventListener('error', function(e) {
            console.log("Error loading audio file", e);
            errorLog.innerText = "Song file not found. Check filename.";
        });
    </script>
</body>
</html>